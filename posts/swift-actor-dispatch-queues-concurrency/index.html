<!DOCTYPE html>
<html>
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">

		<meta charset="utf-8">
		<title>Actors, the cooperative pool and concurrency</title>
		<meta name="viewport" content="width=device-width">
		
		<link rel="stylesheet" href="https://trycombine.com/css/hybrid.css">
		<link rel="stylesheet" href="https://trycombine.com/css/style.css">
		<link rel="stylesheet" href="https://trycombine.com/css/colors-dark.css">
		
		<meta property="og:title" content="Actors, the cooperative pool and concurrency" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Swift development related blog-posts. Combine, modern concurrency model, Instruments, and more." />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://trycombine.com/posts/swift-actor-dispatch-queues-concurrency/" />
<meta property="og:image" content="https://trycombine.com/images/trycombine.png" />
<meta property="og:site_name" content="try Combine" />

<meta name="description" content="Swift development related blog-posts. Combine, modern concurrency model, Instruments, and more.">
<meta name="author" content="Marin Todorov">

<link href rel="alternate" type="application/rss+xml" title="try Combine">

<meta name="twitter:card" content="summary">
<meta name="twitter:description" content="Swift development related blog-posts. Combine, modern concurrency model, Instruments, and more." />
<meta name="twitter:creator" content="@icanzilb" />

<meta name="twitter:title" content="Actors, the cooperative pool and concurrency">


<meta name="twitter:image:src" content="https://trycombine.com/images/trycombine.png">
<meta name="twitter:image:width" content="800">
<meta name="twitter:image:height" content="800">

<link rel="stylesheet" href="https://trycombine.com/css/bootstrap-table.css">

	</head>
	<body>
		<header id="header">
			<h1><a href="https://trycombine.com/">try Code</a></h1>
			<p>by Marin Todorov</p>
			<nav style="border-top: 1px solid #555; height: 36px; border-bottom: 1px solid #555;"> 
	<div id="menu">
		<ul id="combineslack" style="float: right;">
			<li><a href="http://slack.combine.community/"><span>Combine Slack &rsaquo;</span></a></li>
		</ul>
	
		<ul class="nav">
			
				<li><a href="http://www.underplot.com"><span>Contact</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://github.com/icanzilb"><span>Github</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://twitter.com/icanzilb"><span>Twitter</span></a></li>
			
		</ul>
	
	</div>
</nav>

		</header>

		<div id="page">
			<div id="sidebar">
				<div class="sidebar-posts">
    <div class="sidebar-title"><a href="https://trycombine.com/index.xml" class="rss-button"><img src="https://trycombine.com/images/ic_rss_feed_48px.png"></a> Latest posts:</div>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-light-ide-update-jan/">&raquo; &nbsp; 31/Jan &middot; Swift Light IDE update, Jan 31st</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-read-modify-coroutines/">&raquo; &nbsp; 25/Jan &middot; Yielding accessors in Swift</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-async-sequence-extensions-2/">&raquo; &nbsp; 21/Jan &middot; Swift Async Sequence extensions (part 2)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-async-sequence-extensions-1/">&raquo; &nbsp; 19/Jan &middot; Swift Async Sequence extensions (part 1)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/xcode-powerups/">&raquo; &nbsp; 20/Dec &middot; Extending Xcode with power-ups</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/announcing-modern-swift-concurrency-book/">&raquo; &nbsp; 3/Nov &middot; Announcing: ‚ÄúModern Concurrency in Swift‚Äù</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actor-dispatch-queues-concurrency/">&raquo; &nbsp; 6/Oct &middot; Actors, the cooperative pool and concurrency</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/performance-actor-queue-lock-benchmark/">&raquo; &nbsp; 30/Sep &middot; Performance: Actor vs queue vs lock</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/thread-task-sleep/">&raquo; &nbsp; 13/Sep &middot; The difference between Thread.sleep() and Task.sleep()</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-async-sequence-2/">&raquo; &nbsp; 13/Jul &middot; Bridge from Combine to AsyncSequence - the code (p. 2)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-async-sequence-1/">&raquo; &nbsp; 12/Jul &middot; Bridge from Combine to AsyncSequence - the plan (p. 1)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actors-combine/">&raquo; &nbsp; 12/May &middot; Swift Actors: A practical example, part 2</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actors/">&raquo; &nbsp; 10/May &middot; Swift Actors: A practical example, part 1</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/self-weak-unowned/">&raquo; &nbsp; 3/Mar &middot; Using self, weak, and unowned in Combine</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/cancellor/">&raquo; &nbsp; 5/Feb &middot; Owning AnyCancellable with Cancellor</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/timelane-nsspain-2020/">&raquo; &nbsp; 20/Nov &middot; 5 Stranger Things you can do with Timelane at NSSpain</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/how-to-create-custom-instrument/">&raquo; &nbsp; 19/Apr &middot; How to create a custom instrument on top of Timelane!</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/timelane-combine-update/">&raquo; &nbsp; 13/Mar &middot; Timelane - the first two weeks!</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/announcing-timelane-combine/">&raquo; &nbsp; 28/Feb &middot; Announcing: Timelane</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-property-wrappers/">&raquo; &nbsp; 11/Sep &middot; Property Wrappers with Combine</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/subscribe-on-receive-on/">&raquo; &nbsp; 9/Sep &middot; subscribe(on:) vs receive(on:)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combinedatasources-multiple-sections/">&raquo; &nbsp; 7/Sep &middot; Binding a list with multiple sections and different cells</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combinedatasources-simple-static-list/">&raquo; &nbsp; 3/Sep &middot; Binding a simple list to a UITableView</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/assert-max-subscriptions/">&raquo; &nbsp; 29/Aug &middot; An assert operator: assertMaxSubscriptions()</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/debug-logging-combineprintout/">&raquo; &nbsp; 16/Aug &middot; Debug logging with CombinePrintout</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/more-simple-custom-combine-operators-with-sample/">&raquo; &nbsp; 6/Aug &middot; Building a custom `sample` operator</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/simple-custom-combine-operators/">&raquo; &nbsp; 2/Aug &middot; Simple custom Combine operators</a>
      </li>
    
  </div>

<style>
	  .sidebar-post { font-size:0.75em; margin-top:12px; line-height: 14px;}
    .sidebar-post a { text-decoration: none; }
    .sidebar-post a:hover { text-decoration: underline; }
</style>

			</div>

			<div id="content">
				
	<article class="post">
				<div id="promo">
				
			<div id="combinebook" style="font-size: 0.8em; text-align:center; font-family: sans-serif; font-weight: bold;">
				<style>
					#combinebook a:hover { background: transparent!important; }
				</style>
				  <a href="http://swiftconcurrencybook.com" target="_blank" style="text-decoration:none;">
					<img src="https://trycombine.com/images/concurrency-book.png" style="width:140px; box-shadow: 2px 3px #354465;border-radius:5px;"/>
				  </a>
				  <a href="http://swiftconcurrencybook.com">Modern Concurrency<br/> in Swift</a> <span class="new-badge">New</span>
			</div>
        </div>

			
		<h1>Actors, the cooperative pool and concurrency </h1>

<style>
  .twitter-share-button {
  	font-family: 'Helvetica Neue',Arial,sans-serif;
  	background: #4793DA;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  	border-radius: 4px;
  	font-size: 0.85em;
  	line-height: 3em;
  }

  .twitter-share-button:hover {
  	background: #3C769F;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  }

  .twitter-share-button:active {
  	background: #284F6A;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  }

</style>

<p><a class="twitter-share-button"
  href="https://twitter.com/intent/tweet?text=Actors%2c%20the%20cooperative%20pool%20and%20concurrency&url=https%3a%2f%2ftrycombine.com%2fposts%2fswift-actor-dispatch-queues-concurrency%2f"
  data-size="medium">
Tweet</a><p>

		<div class="post-content"><p>After I started doing some benchmarking how different APIs perform, when used to <a href="https://trycombine.com/posts/performance-actor-queue-lock-benchmark/">build a simple counter</a>, I got really interested to learn more about how the new Swift concurrency model behaves at runtime.</p>
<p>So in this post I&rsquo;ll use a couple of actors and make them do concurrent computations and check how the thread list and dispatch-queues look like in the debugger.</p>
<h2 id="the-test-setup">The Test Setup</h2>
<p>I&rsquo;ve prepared a super-duper simple SwiftUI app that does a bunch of floating-point multiplication and division.</p>
<p>In this post, I&rsquo;m using an Xcode 13.0 (13A233) running the test project in an iOS Simulator on my 2018 macbook pro. Keep in mind I&rsquo;ll be running this in debug mode ‚Äî not sure if the release pool behaves differently in release, but that&rsquo;s to dig into in another post.</p>
<h2 id="a-crunch-actor">A Crunch Actor</h2>
<p>I have a simple actor called <code>CrunchActor1</code> that includes a single method that does some number crunching:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">actor CrunchActor1 {
  <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">crunch</span>() -&gt; <span style="color:#24909d">Double</span> {
    <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">result</span> = <span style="color:#3677a9">1.0</span>
    <span style="color:#6ab825;font-weight:bold">for</span> i <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#3677a9">0</span> ... <span style="color:#3677a9">10000000</span> {
      result = result * <span style="color:#3677a9">1.085648466</span>
      result = result / <span style="color:#3677a9">2.085648466</span>
      ...</code></pre></td></tr></table>
</div>
</div>
<p>The point of this is to simply have an actor that does <em>something</em> on its thread for a little while so I can break in the debugger and look at the GCD runtime-situation.</p>
<h3 id="running-a-single-actor-method">Running a single actor method</h3>
<p>On my first try, I&rsquo;m running a single call to <code>crunch()</code> in a SwiftUI task:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 1: </span><span style="color:#ed9d13">\(</span>crunchActor.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}</code></pre></td></tr></table>
</div>
</div>
<p>When I break inside <code>crunch()</code>, I get to learn a few interesting facts:</p>

<img alt="Debugger showing a single dispatch queue with a single thread" src="https://trycombine.com/images/performance/debugger-single-method.png" style="max-width:400px;"/>

<ul>
<li>The <em>cooperative thread pool</em> that was mentioned in the WWDC videos is a <strong>concurrent dispatch queue</strong> called <code>com.apple.root.default-qos.cooperative</code>.</li>
<li>The pool-queue has a <strong>default</strong> quality of service.</li>
<li>The concurrent queue is currently running one code-block in <code>CrunchActor1.crunch()</code> on a single thread.</li>
</ul>
<p>If you are familiar with GCD this really starts to paint a picture.</p>
<p>Also, I heard speculations that an actor is just a serial dispatch queue with compile-time guarantees but it seeems that the debugger disagrees ‚Äî technically, we get a single GCD queue and that&rsquo;s the cooperative pool.</p>
<h3 id="running-actor-methods-concurrently">Running actor methods concurrently</h3>
<p>Next, to quickly confirm that the actor behaves as expected, I&rsquo;m trying two calls to <code>crunch()</code> in parallel:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 1: </span><span style="color:#ed9d13">\(</span>crunchActor.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}
Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 2: </span><span style="color:#ed9d13">\(</span>crunchActor.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}</code></pre></td></tr></table>
</div>
</div>
<p>This code launches two tasks in parallel and each of them calls <code>crunch()</code>. The debugger shows exactly the same layout as before:</p>

<img alt="Debugger showing a single dispatch queue with a single thread" src="https://trycombine.com/images/performance/debugger-two-concurrent-methods.png" style="max-width:400px;"/>

<p>The actor transparently serializes calls to <code>crunch()</code> so the cooperative pool still <strong>creates a single thread</strong> to execute this code.</p>
<h3 id="running-mulitple-actors-in-parallel">Running mulitple actors in parallel</h3>
<p>So, how would the cooperative pool look like if I run two different actors in parallel? For this example I&rsquo;ll use <strong>two actors</strong> ‚Äî <code>crunchActor1</code> and <code>crunchActor2</code>:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 1: </span><span style="color:#ed9d13">\(</span>crunchActor1.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}
Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 2: </span><span style="color:#ed9d13">\(</span>crunchActor1.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}
Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 3: </span><span style="color:#ed9d13">\(</span>crunchActor2.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}
Task.detached {
  result = await <span style="color:#ed9d13">&#34;Result 4: </span><span style="color:#ed9d13">\(</span>crunchActor2.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span>
}</code></pre></td></tr></table>
</div>
</div>
<p>When I break in the debugger now, I see that the pool is using two threads to run the calls to my two actors:</p>

<img alt="Debugger showing a single dispatch queue with two threads" src="https://trycombine.com/images/performance/debugger-multiple-actors.png" style="max-width:400px;"/>

<p>You see that the concurrent queue is running 2 blocks simultaneously on two threads ‚Äî one actor-instance crunching in parallel on each thread.</p>
<p>Next, is where things become <strong>a bit weird</strong> üéÉ.</p>
<h3 id="running-nonisolated-actor-code">Running nonisolated actor code</h3>
<p>So, I&rsquo;m exploring ways to design highly-concurrent code. On a first try, I just annotated <code>crunch()</code> with <code>nonisolated</code> which removes the state-isolation harness for that method.</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">actor CrunchActor1 {
  nonisolated <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">crunch</span>() -&gt; <span style="color:#24909d">Double</span> {
  ...</code></pre></td></tr></table>
</div>
</div>
<p>Xcode instantly nudges me to remove the <code>await</code> keywords ‚Äî so I do and now I&rsquo;m calling <code>crunch()</code> synchronously:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">result = <span style="color:#ed9d13">&#34;Result 1: </span><span style="color:#ed9d13">\(</span>crunchActor.crunch<span style="color:#ed9d13">())</span><span style="color:#ed9d13">&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>Running the debugger, I see that, yet again, only two of my four tasks run concurrently:</p>

<img alt="Debugger showing a single dispatch queue with two threads" src="https://trycombine.com/images/performance/debugger-concurrent-nonisolated.png" style="max-width:400px;"/>

<p>So, this time the calls to <code>crunch()</code> run free but the cooperative pool gives me <strong>only two threads</strong> at a time to run my four concurrent tasks.</p>
<p>Unfortunately, looking at the docs, I&rsquo;m not sure how to <strong>ask for more threads</strong> so it seems I can only &ldquo;spread&rdquo; my work on two CPU cores ü§î. Additionally, I got feedback, that it depends on the machine hardware as to how many cores your pool can spare.</p>
<h3 id="falling-back-on-classes">Falling back on classes</h3>
<p>So I&rsquo;m trying to figure out if maybe actors still somehow serialize or limit the execution of methods even if they are <code>nonisolated</code>. I&rsquo;m going to ditch actors, fall back on classes and check how many threads do I get in that case:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">CrunchActor1</span> {
  <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">crunch</span>() -&gt; <span style="color:#24909d">Double</span> {
    <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">result</span> = <span style="color:#3677a9">1.0</span>
    <span style="color:#6ab825;font-weight:bold">for</span> i <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#3677a9">0</span> ... <span style="color:#3677a9">10000000</span> {
    ...</code></pre></td></tr></table>
</div>
</div>
<p>Yet again, the cooperative pool runs only two blocks at a time on two separate threads:</p>

<img alt="Debugger showing a single dispatch queue with two threads" src="https://trycombine.com/images/performance/debugger-multiple-classes.png" style="max-width:400px;"/>

<p>So it seems that the cooperative pool has <strong>a limit on how much concurrency</strong> should you have access to (to spare you some reading, I&rsquo;m skipping using <code>TaskGroup</code> which produces the same results).</p>
<p>I think to a point, these results make some sense ‚Äî with this black-box limit you&rsquo;re <strong>really</strong> not able to drain the system resources and make other apps unresponsive&hellip;</p>
<h3 id="falling-back-on-dispatchqueueconcurrentperform">Falling back on DispatchQueue.concurrentPerform(&hellip;)</h3>
<p>But what if you <strong>really, really</strong> wanted to do some good, concurrent work? So far, the only solution I found is removing my <code>Task</code> code altogether and falling back on <code>DispatchQueue.concurrentPerform(...)</code>:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">DispatchQueue.concurrentPerform(iterations: <span style="color:#3677a9">4</span>) { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
  <span style="color:#6ab825;font-weight:bold">_</span> = act1.crunch()
}</code></pre></td></tr></table>
</div>
</div>
<p>This code still produces, as pre-iOS 15, a <strong>thread explosion</strong> üî• that runs your parallel code unhindered:</p>

<img alt="Debugger showing a custom queue with four threads" src="https://trycombine.com/images/performance/debugger-concurrent-perform.png" style="max-width:400px;"/>

<p>Pay attention that this is not the cooperative pool anymore ‚Äî it&rsquo;s just a concurrent GCD queue created by <code>concurrentPerform()</code>. It runs code on four threads in parallel and is utilizing four CPU cores quite neatly:</p>

<img alt="Debugger showing an over 350% load of the CPU" src="https://trycombine.com/images/performance/debugger-cpu-four-cores.png" style="max-width:400px;"/>

<h2 id="results">Results</h2>
<p>So it seems that the pool automatically allots threads to <code>async/await</code> code and actors. For most apps this should be perfect ‚Äî the new concurrency model will only get better with time so using the defaults is the best way forward.</p>
<p>For apps where you need to make the most of the machine, it looks like the current solution is <code>DispatchQueue.concurrentPerform(...)</code> or your own operations or threads-based code.</p>
<p>What do you think?</p>
<h2 id="where-to-go-from-here">Where to go from here?</h2>
<p>Interested in the new <code>async/await</code> Swift syntax? Hit me up on twitter at <a href="https://twitter.com/icanzilb">https://twitter.com/icanzilb</a>.</p>
</div>
    <hr/>
    <div><i>If you like these free blog posts, check out some of the books I worked on!</i></div>

    <div id="combinebook">
      <table width="100%">
        <tr>
<td style="font-size: 0.9em; font-family: sans-serif; font-weight: bold; text-align:center;">
  <a href="http://swiftconcurrencybook.com" target="_blank" style="text-decoration:none;">
    <img src="https://trycombine.com/images/concurrency-book.png" style="width:150px; box-shadow: 4px 6px #354465;border-radius:5px;">
  </a>
  <br/>
  <a href="http://swiftconcurrencybook.com">Modern Concurrency in Swift</a><span class="new-badge">New</span>
</td>

<td style="font-size: 0.9em; font-family: sans-serif; font-weight: bold; text-align:center;">
  <a href="http://combinebook.com" target="_blank" style="text-decoration:none;">
    <img src="https://trycombine.com/images/combine.png" style="width:150px; box-shadow: 4px 6px #354465;border-radius:10px;">
  </a>
  <br/>
  <a href="https://combinebook.com">Combine: Asynchronous<br/> programming with Swift</a>
</td>
        </tr>
      </table>
				<br/>
		</div>
		<p class="meta">Posted on <span class="postdate">06. October 2021</span></p>
	</article>
	

			</div>

			<footer id="footer">
				<p class="copyright">
					
						Powered by <a href="https://gohugo.io/">Hugo</a> and the
						<a href="https://github.com/bake/solar-theme-hugo">Solar</a>-theme.
					
				</p>
			</footer>
		</div>

		<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

<script src="https://unpkg.com/@telemetrydeck/sdk/dist/telemetrydeck.min.js" defer></script>

<script>
  window.td = window.td || [];
  td.push(['app', '6DB9CD84-C400-4746-9E87-56EAD0D97492'], ['user', 'anonymous'], ['signal']);
</script>
	</body>
</html>
