<!DOCTYPE html>
<html>
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">

		<meta charset="utf-8">
		<title>Swift Actors: A practical example, part 2</title>
		<meta name="viewport" content="width=device-width">
		
		<link rel="stylesheet" href="https://trycombine.com/css/hybrid.css">
		<link rel="stylesheet" href="https://trycombine.com/css/style.css">
		<link rel="stylesheet" href="https://trycombine.com/css/colors-dark.css">
		
		<meta property="og:title" content="Swift Actors: A practical example, part 2" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Swift development related blog-posts. Combine, modern concurrency model, Instruments, and more." />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://trycombine.com/posts/swift-actors-combine/" />
<meta property="og:image" content="https://trycombine.com/images/trycombine.png" />
<meta property="og:site_name" content="try Combine" />

<meta name="description" content="Swift development related blog-posts. Combine, modern concurrency model, Instruments, and more.">
<meta name="author" content="Marin Todorov">

<link href rel="alternate" type="application/rss+xml" title="try Combine">

<meta name="twitter:card" content="summary">
<meta name="twitter:description" content="Swift development related blog-posts. Combine, modern concurrency model, Instruments, and more." />
<meta name="twitter:creator" content="@icanzilb" />

<meta name="twitter:title" content="Swift Actors: A practical example, part 2">


<meta name="twitter:image:src" content="https://trycombine.com/images/trycombine.png">
<meta name="twitter:image:width" content="800">
<meta name="twitter:image:height" content="800">

<link rel="stylesheet" href="https://trycombine.com/css/bootstrap-table.css">

	</head>
	<body>
		<header id="header">
			<h1><a href="https://trycombine.com/">try Code</a></h1>
			<p>by Marin Todorov</p>
			<nav style="border-top: 1px solid #555; height: 36px; border-bottom: 1px solid #555;"> 
	<div id="menu">
		<ul id="combineslack" style="float: right;">
			<li><a href="http://slack.combine.community/"><span>Combine Slack &rsaquo;</span></a></li>
		</ul>
	
		<ul class="nav">
			
				<li><a href="http://www.underplot.com"><span>Contact</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://github.com/icanzilb"><span>Github</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://twitter.com/icanzilb"><span>Twitter</span></a></li>
			
		</ul>
	
	</div>
</nav>

		</header>

		<div id="page">
			<div id="sidebar">
				<div class="sidebar-posts">
    <div class="sidebar-title"><a href="https://trycombine.com/index.xml" class="rss-button"><img src="https://trycombine.com/images/ic_rss_feed_48px.png"></a> Latest posts:</div>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-light-ide-update-jan/">&raquo; &nbsp; 31/Jan &middot; Swift Light IDE update, Jan 31st</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-read-modify-coroutines/">&raquo; &nbsp; 25/Jan &middot; Yielding accessors in Swift</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-async-sequence-extensions-2/">&raquo; &nbsp; 21/Jan &middot; Swift Async Sequence extensions (part 2)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-async-sequence-extensions-1/">&raquo; &nbsp; 19/Jan &middot; Swift Async Sequence extensions (part 1)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/xcode-powerups/">&raquo; &nbsp; 20/Dec &middot; Extending Xcode with power-ups</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/announcing-modern-swift-concurrency-book/">&raquo; &nbsp; 3/Nov &middot; Announcing: ‚ÄúModern Concurrency in Swift‚Äù</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actor-dispatch-queues-concurrency/">&raquo; &nbsp; 6/Oct &middot; Actors, the cooperative pool and concurrency</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/performance-actor-queue-lock-benchmark/">&raquo; &nbsp; 30/Sep &middot; Performance: Actor vs queue vs lock</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/thread-task-sleep/">&raquo; &nbsp; 13/Sep &middot; The difference between Thread.sleep() and Task.sleep()</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-async-sequence-2/">&raquo; &nbsp; 13/Jul &middot; Bridge from Combine to AsyncSequence - the code (p. 2)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-async-sequence-1/">&raquo; &nbsp; 12/Jul &middot; Bridge from Combine to AsyncSequence - the plan (p. 1)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actors-combine/">&raquo; &nbsp; 12/May &middot; Swift Actors: A practical example, part 2</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actors/">&raquo; &nbsp; 10/May &middot; Swift Actors: A practical example, part 1</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/self-weak-unowned/">&raquo; &nbsp; 3/Mar &middot; Using self, weak, and unowned in Combine</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/cancellor/">&raquo; &nbsp; 5/Feb &middot; Owning AnyCancellable with Cancellor</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/timelane-nsspain-2020/">&raquo; &nbsp; 20/Nov &middot; 5 Stranger Things you can do with Timelane at NSSpain</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/how-to-create-custom-instrument/">&raquo; &nbsp; 19/Apr &middot; How to create a custom instrument on top of Timelane!</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/timelane-combine-update/">&raquo; &nbsp; 13/Mar &middot; Timelane - the first two weeks!</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/announcing-timelane-combine/">&raquo; &nbsp; 28/Feb &middot; Announcing: Timelane</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-property-wrappers/">&raquo; &nbsp; 11/Sep &middot; Property Wrappers with Combine</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/subscribe-on-receive-on/">&raquo; &nbsp; 9/Sep &middot; subscribe(on:) vs receive(on:)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combinedatasources-multiple-sections/">&raquo; &nbsp; 7/Sep &middot; Binding a list with multiple sections and different cells</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combinedatasources-simple-static-list/">&raquo; &nbsp; 3/Sep &middot; Binding a simple list to a UITableView</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/assert-max-subscriptions/">&raquo; &nbsp; 29/Aug &middot; An assert operator: assertMaxSubscriptions()</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/debug-logging-combineprintout/">&raquo; &nbsp; 16/Aug &middot; Debug logging with CombinePrintout</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/more-simple-custom-combine-operators-with-sample/">&raquo; &nbsp; 6/Aug &middot; Building a custom `sample` operator</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/simple-custom-combine-operators/">&raquo; &nbsp; 2/Aug &middot; Simple custom Combine operators</a>
      </li>
    
  </div>

<style>
	  .sidebar-post { font-size:0.75em; margin-top:12px; line-height: 14px;}
    .sidebar-post a { text-decoration: none; }
    .sidebar-post a:hover { text-decoration: underline; }
</style>

			</div>

			<div id="content">
				
	<article class="post">
				<div id="promo">
				
			<div id="combinebook" style="font-size: 0.8em; text-align:center; font-family: sans-serif; font-weight: bold;">
				<style>
					#combinebook a:hover { background: transparent!important; }
				</style>
				  <a href="http://swiftconcurrencybook.com" target="_blank" style="text-decoration:none;">
					<img src="https://trycombine.com/images/concurrency-book.png" style="width:140px; box-shadow: 2px 3px #354465;border-radius:5px;"/>
				  </a>
				  <a href="http://swiftconcurrencybook.com">Modern Concurrency<br/> in Swift</a> <span class="new-badge">New</span>
			</div>
        </div>

			
		<h1>Swift Actors: A practical example, part 2 </h1>

<style>
  .twitter-share-button {
  	font-family: 'Helvetica Neue',Arial,sans-serif;
  	background: #4793DA;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  	border-radius: 4px;
  	font-size: 0.85em;
  	line-height: 3em;
  }

  .twitter-share-button:hover {
  	background: #3C769F;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  }

  .twitter-share-button:active {
  	background: #284F6A;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  }

</style>

<p><a class="twitter-share-button"
  href="https://twitter.com/intent/tweet?text=Swift%20Actors%3a%20A%20practical%20example%2c%20part%202&url=https%3a%2f%2ftrycombine.com%2fposts%2fswift-actors-combine%2f"
  data-size="medium">
Tweet</a><p>

		<div class="post-content"><p>In my previous post <a href="https://trycombine.com/posts/swift-actors/">Swift Actors: A practical example, part 1</a> I covered how I got a Swift.org toolchain from trunk, enabled support for the currently experimental support for structured concurrency, and created a thread-safe cache in few lines of Swift code.</p>
<p>If you missed part 1, definitely do read it first as this post builds upon the code I already covered there. <a href="https://trycombine.com/posts/swift-actors/">¬ª</a></p>
<p>When I wrapped up writing part 1, I was looking at my new cache actor and I started wondering &ldquo;<em>What about Combine?</em>&rdquo;.</p>
<h2 id="what-about-swift-actors-and-combine">What about Swift actors and Combine?</h2>
<p>With all the concurrency advancements like <code>async/await</code>, the <code>Task</code> APIs, and actors - is Combine going to be still needed?</p>
<p>Some simple use cases would be easier with the new APIs. What&rsquo;s more the new concurrency APIs are fully integrated with Swift&rsquo;s error handling which makes the code much simpler to write and read. For example:</p>
<ol>
<li>I believe I won&rsquo;t use <code>Future</code> much more since an <code>async</code> function is much simpler to write.</li>
<li>Reimplementing publishers that only emit series of values and then complete as an <code>AsyncSequence</code> will be easier and more importantly much simpler at the point-of-use.</li>
</ol>
<p>In any case I think the Combine APIs to manage multiple streams of events over time offer a unique angle to asycnhronous value processing. In fact, I think it&rsquo;s great we&rsquo;re getting a simpler way of async/concurrent for simple tasks and still have the option to solve more complex problems with Combine.</p>
<p><strong>So let&rsquo;s add some Combine</strong> to the <code>ActorTest</code> app from part 1!</p>
<h2 id="converting-an-async-function-to-synchronous">Converting an async function to synchronous</h2>
<blockquote>
<p>Huge disclaimer: This post is purely exploratory and is using the experimental Swift concurrency feature which is a work in progress.</p>
</blockquote>
<p>The <code>compute()</code> function from part 1 which precomputes a bunch of hashes and adds them to the cache currently looks like so:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">compute</span>() async {
  addHash(<span style="color:#6ab825;font-weight:bold">for</span>: <span style="color:#3677a9">42</span>)
    
  await withTaskGroup(of: <span style="color:#24909d">Bool</span>.<span style="color:#6ab825;font-weight:bold">self</span>) { group <span style="color:#6ab825;font-weight:bold">in</span>
    <span style="color:#6ab825;font-weight:bold">for</span> number <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#3677a9">0</span> ... <span style="color:#3677a9">15_000</span> {
      group.spawn {
        await <span style="color:#6ab825;font-weight:bold">self</span>.addHash(<span style="color:#6ab825;font-weight:bold">for</span>: number)
        <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">true</span>
      }
    }
  }
}</code></pre></td></tr></table>
</div>
</div>
<p>I&rsquo;d very much like to mix-in some Combine in here to provide a way for an observer to track the progress of precomputing the hashes.</p>
<p>Usually I&rsquo;d return a publisher from the function and let observers subscribe it. However, this function is <code>async</code> so it doesn&rsquo;t return a result until it&rsquo;s finished all its work.</p>
<p>On the other hand, in the structured concurrency proposal I noticed a new function called <code>async(...)</code> that lets you run async code in synchronous contexts.</p>
<p>Let&rsquo;s try that and let <code>compute()</code> return a publisher emitting its progress:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">compute</span>() -&gt; AnyPublisher&lt;<span style="color:#24909d">Int</span>, Never&gt; {
  <span style="color:#6ab825;font-weight:bold">let</span> <span style="color:#40ffff">progress</span> = CurrentValueSubject&lt;<span style="color:#24909d">Int</span>, Never&gt;(<span style="color:#3677a9">0</span>)
  
  async {
    await withTaskGroup(of: <span style="color:#24909d">Bool</span>.<span style="color:#6ab825;font-weight:bold">self</span>) { group <span style="color:#6ab825;font-weight:bold">in</span>

    }
    progress.send(completion: .finished)
  }
  
  <span style="color:#6ab825;font-weight:bold">return</span> progress.eraseToAnyPublisher()
}</code></pre></td></tr></table>
</div>
</div>
<p>It took some trial and error to come up with this code but here&rsquo;s the play-by-play:</p>
<ol>
<li><code>compute()</code> is not <code>async</code> anymore and returns an <code>AnyPublisher&lt;Int, Never&gt;</code> so consumers can subscribe and observe the progress,</li>
<li><code>async(...)</code> creates an asynchronous task to run <code>withTaskGroup(...)</code> so you can actually use <code>await</code> inside the closure body,</li>
<li>Since execution is waiting for <code>withTaskGroup(...)</code> to complete all the group tasks, I can simply emit the <code>.finished</code> publisher event on the next line after <code>withTaskGroup(...)</code>.</li>
<li>Finally (and that&rsquo;s a <strong>bit of an assumption</strong>) Swift&rsquo;s structured concurrency allows me to return from <code>compute()</code> before the code in <code>async</code> completes. <code>async()</code> spawns a child task which runs asynchronously and upon completion also releases the execution of <code>compute()</code>. So in fact my <code>progress</code> subject is alive and well until <code>group</code> completes all its tasks ü§Øü§Øü§Ø.</li>
</ol>
<p>Great! ‚åò+B compiles the code just fine and I&rsquo;m ready to look into fleshing out the code that emits the progress.</p>
<h2 id="task-groups-are-lazy-sequences">Task groups are lazy sequences</h2>
<p>As I mentioned in part 1, the task group API, in its current state, allows you to easily add tasks to the group for concurrent execution by calling <code>spawn(...)</code>. Before completing, <code>withTaskGroup(...)</code> waits until all spawned tasks complete.</p>
<p>There is however a group API that also allows you to control and track the completion of tasks. In my code I&rsquo;d like to send a value via my <code>progress</code> subject each time a task completes.</p>
<p>This is trivial - peaking in the headers shows me that <code>TaskGroup</code> conforms to <code>AsyncSequence</code> and I can get the result of each task when it completes by calling the sequence&rsquo;s <code>next()</code> method:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">await withTaskGroup(of: <span style="color:#24909d">Bool</span>.<span style="color:#6ab825;font-weight:bold">self</span>) { group <span style="color:#6ab825;font-weight:bold">in</span>
  <span style="color:#999;font-style:italic">// Schedule all the tasks.</span>
  <span style="color:#6ab825;font-weight:bold">for</span> number <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#3677a9">0</span> ... <span style="color:#3677a9">15_000</span> {
    group.spawn {
      await <span style="color:#6ab825;font-weight:bold">self</span>.addHash(<span style="color:#6ab825;font-weight:bold">for</span>: number)
      <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">true</span>
    }
  }
  
  <span style="color:#999;font-style:italic">// Consume the tasks as they complete.</span>
  <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">counter</span> = <span style="color:#3677a9">0</span>
  <span style="color:#6ab825;font-weight:bold">while</span> <span style="color:#6ab825;font-weight:bold">let</span> <span style="color:#40ffff">_</span> = await group.next() {
    counter += <span style="color:#3677a9">1</span>
    progress.send(<span style="color:#24909d">Int</span>(<span style="color:#24909d">Double</span>(counter) / <span style="color:#3677a9">15_000.0</span> * <span style="color:#3677a9">100</span>))
  }
}</code></pre></td></tr></table>
</div>
</div>
<p>The first half of the body now spawns all the tasks in the group and the <code>while</code> loop consumes the results of the concurrent tasks as soon as they complete (but still synchronously).</p>
<p>I love this design because with just few lines of code you create both:</p>
<ul>
<li>the concurrent exection that does the heavy work, and</li>
<li>the synchronized handler where you can safely process the results ü•∞.</li>
</ul>
<p>The code, emitting the progress, counts the completed tasks and calls into <code>progress.send(...)</code> to emit the current progress value.</p>
<h2 id="subscribing-the-progress-publisher">Subscribing the progress publisher</h2>
<p>The rewrite with Combine is essentially completed. I still need to subscribe <code>compute()</code> and print the progress to the console.</p>
<p>That&rsquo;s the easiest task so far:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6ab825;font-weight:bold">static</span> <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">sub</span>: AnyCancellable?

<span style="color:#6ab825;font-weight:bold">static</span> <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() async {
  sub = await cache.compute()
    .removeDuplicates()
    .sink(receiveValue: { progress <span style="color:#6ab825;font-weight:bold">in</span>
      print(<span style="color:#ed9d13">&#34;Computing: </span><span style="color:#ed9d13">\(</span>progress<span style="color:#ed9d13">)</span><span style="color:#ed9d13">%&#34;</span>)
    })
}</code></pre></td></tr></table>
</div>
</div>
<p><code>compute()</code> is not <code>async</code> anymore but since it&rsquo;s an actor method I still had to use <code>await</code>. The rest was easy as pie - <code>removeDuplicates()</code> emits only the unique progress values, and the code in <code>sink(...)</code> prints out the progress.</p>
<p>When I build and run - the progress shows up in Xcode&rsquo;s console:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">...
Computing: 96%
Computing: 97%
Computing: 98%
Computing: 99%
Computing: 100%
Program ended with exit code: 0</code></pre></div>
<h2 id="the-complete-actortest-app-with-combine">The complete ActorTest app with Combine</h2>
<p>Here&rsquo;s how the complete <strong>App.swift</strong> developed in this post look like:</p>
<div class="highlight"><div style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf;text-decoration:underline">Foundation</span>
<span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf;text-decoration:underline">CryptoKit</span>
<span style="color:#6ab825;font-weight:bold">import</span> <span style="color:#447fcf;text-decoration:underline">Combine</span>

@available(macOS <span style="color:#3677a9">9999</span>, *)
@main
<span style="color:#6ab825;font-weight:bold">struct</span> <span style="color:#447fcf;text-decoration:underline">App</span> {
  <span style="color:#6ab825;font-weight:bold">static</span> <span style="color:#6ab825;font-weight:bold">let</span> <span style="color:#40ffff">cache</span> = HashCache()
  <span style="color:#6ab825;font-weight:bold">static</span> <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">sub</span>: AnyCancellable?
  
  <span style="color:#6ab825;font-weight:bold">static</span> <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">main</span>() async {
    sub = await cache.compute()
      .removeDuplicates()
      .sink(receiveValue: { progress <span style="color:#6ab825;font-weight:bold">in</span>
        print(<span style="color:#ed9d13">&#34;Computing: </span><span style="color:#ed9d13">\(</span>progress<span style="color:#ed9d13">)</span><span style="color:#ed9d13">%&#34;</span>)
      })
  }
}

@available(macOS <span style="color:#3677a9">9999</span>, *)
actor HashCache {
  <span style="color:#6ab825;font-weight:bold">private</span>(<span style="color:#6ab825;font-weight:bold">set</span>) <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">hashes</span> = [<span style="color:#24909d">Int</span>: <span style="color:#24909d">String</span>]()
  
  <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">addHash</span>(<span style="color:#6ab825;font-weight:bold">for</span> number: <span style="color:#24909d">Int</span>) {
    <span style="color:#6ab825;font-weight:bold">let</span> <span style="color:#40ffff">string</span> = SHA512.hash(data: 
      Data(<span style="color:#24909d">String</span>(number).utf8)
    ).description
        
    hashes[number] = string
  }
  
  <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">compute</span>() -&gt; AnyPublisher&lt;<span style="color:#24909d">Int</span>, Never&gt; {
    <span style="color:#6ab825;font-weight:bold">let</span> <span style="color:#40ffff">progress</span> = CurrentValueSubject&lt;<span style="color:#24909d">Int</span>, Never&gt;(<span style="color:#3677a9">0</span>)
    
    async {
      await withTaskGroup(of: <span style="color:#24909d">Bool</span>.<span style="color:#6ab825;font-weight:bold">self</span>) { group <span style="color:#6ab825;font-weight:bold">in</span>
        <span style="color:#999;font-style:italic">// Schedule all the tasks.</span>
        <span style="color:#6ab825;font-weight:bold">for</span> number <span style="color:#6ab825;font-weight:bold">in</span> <span style="color:#3677a9">0</span> ... <span style="color:#3677a9">15_000</span> {
          group.spawn {
            await <span style="color:#6ab825;font-weight:bold">self</span>.addHash(<span style="color:#6ab825;font-weight:bold">for</span>: number)
            <span style="color:#6ab825;font-weight:bold">return</span> <span style="color:#6ab825;font-weight:bold">true</span>
          }
        }
        
        <span style="color:#999;font-style:italic">// Consume the tasks as they complete.</span>
        <span style="color:#6ab825;font-weight:bold">var</span> <span style="color:#40ffff">counter</span> = <span style="color:#3677a9">0.0</span>
        <span style="color:#6ab825;font-weight:bold">while</span> <span style="color:#6ab825;font-weight:bold">let</span> <span style="color:#40ffff">_</span> = await group.next() {
          counter += <span style="color:#3677a9">1</span>
          progress.send(<span style="color:#24909d">Int</span>(counter / <span style="color:#3677a9">15_000.0</span> * <span style="color:#3677a9">100</span>))
        }
      }
      
      progress.send(<span style="color:#3677a9">100</span>)
      progress.send(completion: .finished)
    }
    
    <span style="color:#6ab825;font-weight:bold">return</span> progress.eraseToAnyPublisher()
  }
}</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>Final disclaimer: Developed using a Swift toolchain from the Swift.org trunk branch. The concurrency feature is a work-in-progress. This code might not work at a later moment.</p>
</blockquote>
<hr>
<h2 id="where-to-go-from-here">Where to go from here?</h2>
<p>All of the concurrency features in Swift are still work in progress. You don&rsquo;t need to be learning them as of right now as syntax or behavior might change, so I hope this post <em>does not</em> put any unnecessary pressure on you.</p>
<p>That&rsquo;s also the reason why I&rsquo;ve also put so many disclaimers in the post - this write-up is purely exploratory.</p>
<p>Hit me up with your ideas, replies, and feedback on Twitter at <a href="https://twitter.com/icanzilb">https://twitter.com/icanzilb</a>.</p>
</div>
    <hr/>
    <div><i>If you like these free blog posts, check out some of the books I worked on!</i></div>

    <div id="combinebook">
      <table width="100%">
        <tr>
<td style="font-size: 0.9em; font-family: sans-serif; font-weight: bold; text-align:center;">
  <a href="http://swiftconcurrencybook.com" target="_blank" style="text-decoration:none;">
    <img src="https://trycombine.com/images/concurrency-book.png" style="width:150px; box-shadow: 4px 6px #354465;border-radius:5px;">
  </a>
  <br/>
  <a href="http://swiftconcurrencybook.com">Modern Concurrency in Swift</a><span class="new-badge">New</span>
</td>

<td style="font-size: 0.9em; font-family: sans-serif; font-weight: bold; text-align:center;">
  <a href="http://combinebook.com" target="_blank" style="text-decoration:none;">
    <img src="https://trycombine.com/images/combine.png" style="width:150px; box-shadow: 4px 6px #354465;border-radius:10px;">
  </a>
  <br/>
  <a href="https://combinebook.com">Combine: Asynchronous<br/> programming with Swift</a>
</td>
        </tr>
      </table>
				<br/>
		</div>
		<p class="meta">Posted on <span class="postdate">12. May 2021</span></p>
	</article>
	

			</div>

			<footer id="footer">
				<p class="copyright">
					
						Powered by <a href="https://gohugo.io/">Hugo</a> and the
						<a href="https://github.com/bake/solar-theme-hugo">Solar</a>-theme.
					
				</p>
			</footer>
		</div>

		<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34358526-8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34358526-8');
</script>
	</body>
</html>
