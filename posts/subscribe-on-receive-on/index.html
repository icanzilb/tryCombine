<!DOCTYPE html>
<html>
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">

		<meta charset="utf-8">
		<title>subscribe(on:) vs receive(on:)</title>
		<meta name="viewport" content="width=device-width">
		
		<link rel="stylesheet" href="https://trycombine.com/css/hybrid.css">
		<link rel="stylesheet" href="https://trycombine.com/css/style.css">
		<link rel="stylesheet" href="https://trycombine.com/css/colors-dark.css">
		
		<meta property="og:title" content="subscribe(on:) vs receive(on:)" />
<meta property="og:type" content="website" />
<meta property="og:description" content="The difference between subscribe(on:) and receive(on:) in Combine and when to use which operator" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://trycombine.com/posts/subscribe-on-receive-on/" />
<meta property="og:image" content="https://trycombine.com/images/trycombine.png" />
<meta property="og:site_name" content="try Combine" />

<meta name="description" content="The difference between subscribe(on:) and receive(on:) in Combine and when to use which operator">
<meta name="author" content="Marin Todorov">

<link href rel="alternate" type="application/rss+xml" title="try Combine">

<meta name="twitter:card" content="summary">
<meta name="twitter:description" content="The difference between subscribe(on:) and receive(on:) in Combine and when to use which operator" />
<meta name="twitter:creator" content="@icanzilb" />

<meta name="twitter:title" content="subscribe(on:) vs receive(on:)">


<meta name="twitter:image:src" content="https://trycombine.com/images/trycombine.png">
<meta name="twitter:image:width" content="800">
<meta name="twitter:image:height" content="800">

<link rel="stylesheet" href="https://trycombine.com/css/bootstrap-table.css">

	</head>
	<body>
		<header id="header">
			<h1><a href="https://trycombine.com/">try Code</a></h1>
			<p>by Marin Todorov</p>
			<nav style="border-top: 1px solid #555; height: 36px; border-bottom: 1px solid #555;"> 
	<div id="menu">
		<ul id="combineslack" style="float: right;">
			<li><a href="http://slack.combine.community/"><span>Combine Slack &rsaquo;</span></a></li>
		</ul>
	
		<ul class="nav">
			
				<li><a href="http://www.underplot.com"><span>Contact</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://github.com/icanzilb"><span>Github</span></a></li>
			
		</ul>
	
		<ul class="nav">
			
				<li><a href="https://twitter.com/icanzilb"><span>Twitter</span></a></li>
			
		</ul>
	
	</div>
</nav>

		</header>

		<div id="page">
			<div id="sidebar">
				<div class="sidebar-posts">
    <div class="sidebar-title"><a href="https://trycombine.com/index.xml" class="rss-button"><img src="https://trycombine.com/images/ic_rss_feed_48px.png"></a> Latest posts:</div>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/introducing-got-jobs/">&raquo; &nbsp; 6/Nov &middot; Introducing: Got Jobs?</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/introducing-markcodable/">&raquo; &nbsp; 6/Sep &middot; Introducing MarkCodable</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/introducing-timeui/">&raquo; &nbsp; 20/Mar &middot; Introducing timeui</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-performance-concurrency-4/">&raquo; &nbsp; 14/Mar &middot; Optimization in Swift, part 4</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-performance-concurrency-3/">&raquo; &nbsp; 10/Mar &middot; Optimization in Swift, part 3</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-performance-concurrency-2/">&raquo; &nbsp; 9/Mar &middot; Optimization in Swift, part 2</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-performance-concurrency-1/">&raquo; &nbsp; 3/Mar &middot; Optimization in Swift, part 1</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-concurrency-task-group-workflow/">&raquo; &nbsp; 21/Feb &middot; TaskGroup as a workflow design tool</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-concurrency-task-group/">&raquo; &nbsp; 16/Feb &middot; The issue with task groups or how I discovered a solved problem</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-light-ide-update-jan/">&raquo; &nbsp; 31/Jan &middot; Swift Light IDE update, Jan 31st</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-read-modify-coroutines/">&raquo; &nbsp; 25/Jan &middot; Yielding accessors in Swift</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-async-sequence-extensions-2/">&raquo; &nbsp; 21/Jan &middot; Swift Async Sequence extensions (part 2)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-async-sequence-extensions-1/">&raquo; &nbsp; 19/Jan &middot; Swift Async Sequence extensions (part 1)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/xcode-powerups/">&raquo; &nbsp; 20/Dec &middot; Extending Xcode with power-ups</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/announcing-modern-swift-concurrency-book/">&raquo; &nbsp; 3/Nov &middot; Announcing: “Modern Concurrency in Swift”</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actor-dispatch-queues-concurrency/">&raquo; &nbsp; 6/Oct &middot; Actors, the cooperative pool and concurrency</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/performance-actor-queue-lock-benchmark/">&raquo; &nbsp; 30/Sep &middot; Performance: Actor vs queue vs lock</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/thread-task-sleep/">&raquo; &nbsp; 13/Sep &middot; The difference between Thread.sleep() and Task.sleep()</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-async-sequence-2/">&raquo; &nbsp; 13/Jul &middot; Bridge from Combine to AsyncSequence - the code (p. 2)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-async-sequence-1/">&raquo; &nbsp; 12/Jul &middot; Bridge from Combine to AsyncSequence - the plan (p. 1)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actors-combine/">&raquo; &nbsp; 12/May &middot; Swift Actors: A practical example, part 2</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/swift-actors/">&raquo; &nbsp; 10/May &middot; Swift Actors: A practical example, part 1</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/self-weak-unowned/">&raquo; &nbsp; 3/Mar &middot; Using self, weak, and unowned in Combine</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/cancellor/">&raquo; &nbsp; 5/Feb &middot; Owning AnyCancellable with Cancellor</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/timelane-nsspain-2020/">&raquo; &nbsp; 20/Nov &middot; 5 Stranger Things you can do with Timelane at NSSpain</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/how-to-create-custom-instrument/">&raquo; &nbsp; 19/Apr &middot; How to create a custom instrument on top of Timelane!</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/timelane-combine-update/">&raquo; &nbsp; 13/Mar &middot; Timelane - the first two weeks!</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/announcing-timelane-combine/">&raquo; &nbsp; 28/Feb &middot; Announcing: Timelane</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combine-property-wrappers/">&raquo; &nbsp; 11/Sep &middot; Property Wrappers with Combine</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/subscribe-on-receive-on/">&raquo; &nbsp; 9/Sep &middot; subscribe(on:) vs receive(on:)</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combinedatasources-multiple-sections/">&raquo; &nbsp; 7/Sep &middot; Binding a list with multiple sections and different cells</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/combinedatasources-simple-static-list/">&raquo; &nbsp; 3/Sep &middot; Binding a simple list to a UITableView</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/assert-max-subscriptions/">&raquo; &nbsp; 29/Aug &middot; An assert operator: assertMaxSubscriptions()</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/debug-logging-combineprintout/">&raquo; &nbsp; 16/Aug &middot; Debug logging with CombinePrintout</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/more-simple-custom-combine-operators-with-sample/">&raquo; &nbsp; 6/Aug &middot; Building a custom `sample` operator</a>
      </li>
    
      <li class="sidebar-post" style="margin-top: 12px;">
          <a href="https://trycombine.com/posts/simple-custom-combine-operators/">&raquo; &nbsp; 2/Aug &middot; Simple custom Combine operators</a>
      </li>
    
  </div>

<style>
	  .sidebar-post { font-size:0.75em; margin-top:12px; line-height: 14px;}
    .sidebar-post a { text-decoration: none; }
    .sidebar-post a:hover { text-decoration: underline; }
</style>

			</div>

			<div id="content">
				
	<article class="post">
				<div id="promo">
				
			<div id="combinebook" style="font-size: 0.8em; text-align:center; font-family: sans-serif; font-weight: bold;">
				<style>
					#combinebook a:hover { background: transparent!important; }
				</style>
				  <a href="http://swiftconcurrencybook.com" target="_blank" style="text-decoration:none;">
					<img src="https://trycombine.com/images/concurrency-book.png" style="width:140px; box-shadow: 2px 3px #354465;border-radius:5px;"/>
				  </a>
				  <a href="http://swiftconcurrencybook.com">Modern Concurrency<br/> in Swift</a> <span class="new-badge">New</span>
			</div>
        </div>

			
		<h1>subscribe(on:) vs receive(on:) </h1>

<style>
  .twitter-share-button {
  	font-family: 'Helvetica Neue',Arial,sans-serif;
  	background: #4793DA;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  	border-radius: 4px;
  	font-size: 0.85em;
  	line-height: 3em;
  }

  .twitter-share-button:hover {
  	background: #3C769F;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  }

  .twitter-share-button:active {
  	background: #284F6A;
  	color: white;
  	padding-left: 16px;
  	padding-right: 16px;
  	margin-top: 2px;
  }

</style>

<p><a class="twitter-share-button"
  href="https://twitter.com/intent/tweet?text=subscribe%28on%3a%29%20vs%20receive%28on%3a%29&url=https%3a%2f%2ftrycombine.com%2fposts%2fsubscribe-on-receive-on%2f"
  data-size="medium">
Tweet</a><p>

		<div class="post-content"><p>In this post, instead of looking into the basics of multi-threading with Combine, we are going to have a look at the difference between <code>subscribe(on:)</code> and <code>receive(on:)</code> specifically.</p>
<p>We&rsquo;re going to look at a typical subscription chain starting with a root publisher, a couple of operators, and a subscriber at the end.</p>
<p><img src="https://trycombine.com/images/subscribe-receive/subscription.png" alt="Typical subscription diagram"></p>
<p>We&rsquo;ll look into more diagrams and some example code of how <code>subscribe(on:)</code> and <code>receive(on:)</code> affect subscriptions.</p>
<h2 id="subscribeon">subscribe(on:)</h2>
<p><code>subscribe(on:)</code> sets the scheduler on which you&rsquo;d like the current subscription to be &ldquo;managed&rdquo; on. This operator sets the scheduler to use for creating the subscription, cancelling, and requesting input.</p>
<p>In other words <code>subscribe(on:)</code> sets the scheduler to <strong>subscribe the upstream on</strong>.</p>
<p>A side effect of subscribing on the given scheduler is that <code>subscribe(on:)</code> also changes the scheduler for its downstream like so:</p>
<p><img src="https://trycombine.com/images/subscribe-receive/subscribe-on.png" alt="Subscribe on operator"></p>
<blockquote>
<p>Note: Except if you don&rsquo;t explictly set the downstream receving scheduler via <code>receive(on:)</code>, we&rsquo;ll look at that case further down.</p>
</blockquote>
<p>For the purpose of this post I&rsquo;ll use a custom publisher which when subscribed prints whether it&rsquo;s subscribed on the main thread or not:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">extension</span> <span style="color:#447fcf;text-decoration:underline">Publishers</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#6ab825;font-weight:bold">struct</span> <span style="color:#447fcf;text-decoration:underline">IsMainThread</span>: Publisher {
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">typealias</span> Output = <span style="color:#24909d">String</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">typealias</span> Failure = Never
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">receive</span>&lt;S&gt;(subscriber: S) <span style="color:#6ab825;font-weight:bold">where</span> S : Subscriber, 
</span></span><span style="display:flex;"><span>      Never == S.Failure, <span style="color:#24909d">String</span> == S.Input {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      debugPrint(<span style="color:#ed9d13">&#34;IsMainThread: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>      subscriber.receive(subscription: Subscriptions.empty)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      DispatchQueue.main.async {
</span></span><span style="display:flex;"><span>        <span style="color:#6ab825;font-weight:bold">_</span> = subscriber.receive(<span style="color:#ed9d13">&#34;test&#34;</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<blockquote>
<p>Note: This is an oversimplified publisher for debug purposes that doesn&rsquo;t create its own subscription. If you want to learn how to create your own publishers correctly have a look at  <a href="http://combinebook.com">Combine: Asynchronous programming with Swift</a>.</p>
</blockquote>
<p>The <code>IsMainThread</code> publishers pushes an empty subscription to the subscriber and emits asynchronously a single test output value. The publisher always emits its only value on the main queue.</p>
<p>Additionally, while receiving a new subscriber it prints whether the code runs on the main thread or not.</p>
<p>Let&rsquo;s subscribe that publisher on the main thread and see the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">override</span> <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">viewDidLoad</span>() {
</span></span><span style="display:flex;"><span>  Publishers.IsMainThread()
</span></span><span style="display:flex;"><span>    .sink { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>      print(<span style="color:#ed9d13">&#34;Sink: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    .store(<span style="color:#6ab825;font-weight:bold">in</span>: &amp;subscriptions)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>This outputs:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>IsMainThread: <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>Sink: <span style="color:#6ab825;font-weight:bold">true</span></span></span></code></pre></div>
<p>So both the publisher and the sink code are executed on the main thread which is the current thread in a <code>viewDidLoad()</code> method.</p>
<p>Let&rsquo;s try now inserting a <code>subscribe(on:)</code> directly after the publisher like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#6ab825;font-weight:bold">override</span> <span style="color:#6ab825;font-weight:bold">func</span> <span style="color:#447fcf">viewDidLoad</span>() {
</span></span><span style="display:flex;"><span>  Publishers.IsMainThread()
</span></span><span style="display:flex;"><span>    .subscribe(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>    .sink { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>      print(<span style="color:#ed9d13">&#34;Sink: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    .store(<span style="color:#6ab825;font-weight:bold">in</span>: &amp;subscriptions)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>This time the output is:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>IsMainThread: <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>Sink: <span style="color:#6ab825;font-weight:bold">false</span></span></span></code></pre></div>
<p>This time <code>subscribe(on:)</code> subscribes its upstream on the given global queue and that&rsquo;s why the code inside <code>Publisher.IsMainThread</code> outputs <code>false</code>. As a side effect subscribing the publisher on a global queue also results in the output downstream being delivered on the same queue so sink also prints out a <code>false</code>.</p>
<p>Now let&rsquo;s insert an operator (which means another publisher) in between <code>Publisher.IsMainThread</code> and <code>subscribe(on:)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>Publishers.IsMainThread()
</span></span><span style="display:flex;"><span>  .map { <span style="color:#40ffff">$0</span> }
</span></span><span style="display:flex;"><span>  .subscribe(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>  .sink { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#ed9d13">&#34;Sink: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  .store(<span style="color:#6ab825;font-weight:bold">in</span>: &amp;subscriptions)</span></span></code></pre></div>
<p>The output remains the same:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>IsMainThread: <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>Sink: <span style="color:#6ab825;font-weight:bold">false</span></span></span></code></pre></div>
<p>Subscribing to <code>map(...)</code> on a global queue leads to also subscribing <code>Publishers.IsMainThread</code> on that queue. So using <code>subscribe(on:)</code> sets the subscribing scheduler all the way up the stream.</p>
<p>Let&rsquo;s see what will happen if we use two or more <code>subscribe(on:)</code> operators in the same chain:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>Publishers.IsMainThread()
</span></span><span style="display:flex;"><span>  .subscribe(on: DispatchQueue.main)
</span></span><span style="display:flex;"><span>  .map { <span style="color:#40ffff">$0</span> }
</span></span><span style="display:flex;"><span>  .subscribe(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>  .sink { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#ed9d13">&#34;Sink: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  .store(<span style="color:#6ab825;font-weight:bold">in</span>: &amp;subscriptions)</span></span></code></pre></div>
<p>The output this time is:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>IsMainThread: <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>Sink: <span style="color:#6ab825;font-weight:bold">true</span></span></span></code></pre></div>
<p>The subscribing works correctly up the stream - the upper most <code>subscribe(on:)</code> creates the <code>Publishers.IsMainThread</code> subscription on the main queue.</p>
<p>However, the value delivered to the <code>sink</code> subscriber is also delivered on the main queue&hellip;</p>
<p>This example shows that changing the downstream scheduler with <code>subscribe(on:)</code> is merely a side effect which you should not rely on. <code>subscribe(on:)</code> is for controlling the upstream opeartions: subscribe, cancel, and request input.</p>
<h2 id="receiveon">receive(on:)</h2>
<p>The correct operator to use to change the scheduler where downstream output is delivered is <code>receive(on:)</code>.</p>
<p>On other words <code>receive(on:)</code> sets the scheduler where <strong>the downstream receives output on</strong>.</p>
<p>You can use <code>receive(on:)</code> similarly to <code>subscribe(on:)</code>. You can use multiple <code>receive(on:)</code> operators and that will always change the downstream scheduler:</p>
<p><img src="https://trycombine.com/images/subscribe-receive/receive-on.png" alt="Receive on operator"></p>
<p>Let&rsquo;s try few examples. First let&rsquo;s revisit our first piece of code and try a <code>receive(on:)</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>Publishers.IsMainThread()
</span></span><span style="display:flex;"><span>  .receive(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>  .sink { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#ed9d13">&#34;Sink: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  .store(<span style="color:#6ab825;font-weight:bold">in</span>: &amp;subscriptions)</span></span></code></pre></div>
<p>The output this time:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>IsMainThread: <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>Sink: <span style="color:#6ab825;font-weight:bold">false</span></span></span></code></pre></div>
<p>So unlike trying the same thing with <code>subscribe(on:)</code>, <code>receive(on:)</code> changes the queue only to its downstream. That&rsquo;s why <code>Publisher.IsMainThread()</code> this time is created on the current thread (which in my case is the main one) and the sink code is ran on a global queue.</p>
<p>We can try multiple <code>receive(on:)</code> operators by inserting an extra <code>map(...)</code> in between like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>Publishers.IsMainThread()
</span></span><span style="display:flex;"><span>  .receive(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>  .map { value -&gt; <span style="color:#24909d">String</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    debugPrint(<span style="color:#ed9d13">&#34;Map: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#6ab825;font-weight:bold">return</span> value
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  .receive(on: DispatchQueue.main)
</span></span><span style="display:flex;"><span>  .sink { <span style="color:#6ab825;font-weight:bold">_</span> <span style="color:#6ab825;font-weight:bold">in</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#ed9d13">&#34;Sink: </span><span style="color:#ed9d13">\(</span>Thread.isMainThread<span style="color:#ed9d13">)</span><span style="color:#ed9d13">&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  .store(<span style="color:#6ab825;font-weight:bold">in</span>: &amp;subscriptions)</span></span></code></pre></div>
<p>Which prints:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>IsMainThread: <span style="color:#6ab825;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>Map: <span style="color:#6ab825;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>Sink: <span style="color:#6ab825;font-weight:bold">true</span></span></span></code></pre></div>
<p>This time around what goes down is:</p>
<ol>
<li>The subscription is created on the current queue - the main one</li>
<li>I switch the executuion to a new global queue</li>
<li><code>map()</code> executes</li>
<li>I switch to the main queue</li>
<li><code>sink</code> executes</li>
</ol>
<blockquote>
<p>Note: <code>Publishers.IsMainThread</code> always outputs its value on the main queue (you can revise the publisher code from the beginning of the post). <code>receive(on:)</code> overrides that and switches to your desired scheduler regardless what queue does the publisher code use internally.</p>
</blockquote>
<p>This is very helpful when for example you&rsquo;re adding your code in a view controller callback like <code>viewDidLoad()</code> or another code running on the main queue. Your subscription can switch to a global queue in order to fetch data from the network or disk and process it, and finally switch back to the main queue to update your app&rsquo;s UI.</p>
<h2 id="mix-and-match">Mix and Match</h2>
<p>In a multi-threaded environment you are likely to want to control both on which schedulers you subscribe and receive output. Here&rsquo;s how a more complex chain that gets data from a resource intensive publisher (it reads data from disk for example), then processes the data in a global queue, and finally updates the UI looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span>[Resource Intensive Publisher]
</span></span><span style="display:flex;"><span>  .subscribe(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>  .receive(on: DispatchQueue.global())
</span></span><span style="display:flex;"><span>  [Resource Intensive Processing of Output]
</span></span><span style="display:flex;"><span>  .receive(on: DispatchQueue.main)
</span></span><span style="display:flex;"><span>  [Update App UI on the Main Queue]</span></span></code></pre></div>
<p>Hopefully that clears any confusion about <code>subscribe(on:)</code> vs <code>receive(on:)</code> and you can start enjoying multi-threading Combine style :)</p>
<h2 id="where-to-go-from-here">Where to go from here?</h2>
<p>To learn about multi-threading and working with schedulers in depth check out <a href="http://combinebook.com">Combine: Asynchronous programming with Swift</a> - this is where you can see all updates, discuss in the website forums, and more.</p>
</div>
    <hr/>
    <div><i>If you like these free blog posts, check out some of the books I worked on!</i></div>

    <div id="combinebook">
      <table width="100%">
        <tr>
<td style="font-size: 0.9em; font-family: sans-serif; font-weight: bold; text-align:center;">
  <a href="http://swiftconcurrencybook.com" target="_blank" style="text-decoration:none;">
    <img src="https://trycombine.com/images/concurrency-book.png" style="width:150px; box-shadow: 4px 6px #354465;border-radius:5px;">
  </a>
  <br/>
  <a href="http://swiftconcurrencybook.com">Modern Concurrency in Swift</a><span class="new-badge">New</span>
</td>

<td style="font-size: 0.9em; font-family: sans-serif; font-weight: bold; text-align:center;">
  <a href="http://combinebook.com" target="_blank" style="text-decoration:none;">
    <img src="https://trycombine.com/images/combine.png" style="width:150px; box-shadow: 4px 6px #354465;border-radius:10px;">
  </a>
  <br/>
  <a href="https://combinebook.com">Combine: Asynchronous<br/> programming with Swift</a>
</td>
        </tr>
      </table>
				<br/>
		</div>
		<p class="meta">Posted on <span class="postdate">09. September 2019</span></p>
	</article>
	

			</div>

			<footer id="footer">
				<p class="copyright">
					
						Powered by <a href="https://gohugo.io/">Hugo</a> and the
						<a href="https://github.com/bake/solar-theme-hugo">Solar</a>-theme.
					
				</p>
			</footer>
		</div>

		<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

<script src="https://unpkg.com/@telemetrydeck/sdk/dist/telemetrydeck.min.js" defer></script>

<script>
  if (window.location.href.indexOf("localhost") < 0) {
    window.td = window.td || [];
    td.push(['app', '6DB9CD84-C400-4746-9E87-56EAD0D97492'], ['user', 'anonymous'], ['signal']);
  } else {
      console.log('localhost');
  }
</script>
	</body>
</html>
